@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = "Gestión de Perfiles";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Estilos para el Switch (Checkbox bonito) */
    .form-check-input:checked {
        background-color: #004aad;
        border-color: #004aad;
    }

    /* Estilo del Acordeón */
    .accordion-button:not(.collapsed) {
        color: #004aad;
        background-color: #eef2ff;
        font-weight: bold;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }

    /* Scroll interno para el árbol si es muy largo */
    #tree-container {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }
</style>

<div class="container mt-4 mb-5">

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4 bg-light border-start border-5 border-primary">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1 text-primary fw-bold"><i class="fas fa-user-cog me-2"></i>Gestión de Perfiles y Accesos</h4>
                    <p class="text-muted small mb-0">Seleccione un perfil para configurar sus usuarios y permisos del sistema.</p>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-uppercase small">Perfil a Configurar:</label>
                    @Html.DropDownList("PerfilSeleccionado", ViewBag.ListaPerfiles as SelectList,
                    "-- Seleccione Perfil --", new { @class = "form-select form-select-lg shadow-sm", @id = "cboPerfil" })
                </div>
            </div>
        </div>
    </div>

    <div id="panelConfiguracion" style="display:none;">

        <ul class="nav nav-tabs" id="perfilTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#tab-usuarios" type="button" role="tab">
                    <i class="fas fa-users me-2"></i>Asignar Usuarios
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="permisos-tab" data-bs-toggle="tab" data-bs-target="#tab-permisos" type="button" role="tab">
                    <i class="fas fa-list-check me-2"></i>Permisos de Menú
                </button>
            </li>
        </ul>

        <div class="tab-content bg-white border border-top-0 p-4 shadow-sm rounded-bottom" id="perfilTabsContent">

            <div class="tab-pane fade show active" id="tab-usuarios" role="tabpanel">
                <div class="alert alert-info border-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Aquí se cargará la vista de asignación de usuarios (Listas Izquierda/Derecha).
                </div>
            </div>

            <div class="tab-pane fade" id="tab-permisos" role="tabpanel">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-secondary mb-0">Opciones del Sistema</h5>
                    <button type="button" class="btn btn-success fw-bold" onclick="guardarPermisos()">
                        <i class="fas fa-save me-2"></i>Guardar Permisos
                    </button>
                </div>

                <div id="tree-container">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x"></i><br>Cargando opciones...
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        var urlObtenerArbol = '@Url.Action("ObtenerArbolPermisos", "Permisos")';
        var urlGuardarPermisos = '@Url.Action("GuardarPermisos", "Permisos")';

        $(document).ready(function () {

            // AL CAMBIAR EL COMBO DE PERFIL
            $("#cboPerfil").change(function () {
                var idPerfil = $(this).val();

                if (idPerfil === "") {
                    $("#panelConfiguracion").slideUp();
                    return;
                }

                // 1. Mostrar panel
                $("#panelConfiguracion").slideDown();

                // 2. Cargar datos del Tab Permisos
                cargarArbolPermisos(idPerfil);

                // 3. AQUÍ LLAMARÍAS A TU LÓGICA DE CARGAR USUARIOS
                // cargarUsuarios(idPerfil);
            });

        });

        // --- FUNCIÓN 1: CARGAR ÁRBOL (GET) ---
        function cargarArbolPermisos(idPerfil) {
            $("#tree-container").html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Cargando menú...</p></div>');

            $.ajax({
                url: urlObtenerArbol,
                type: "GET",
                data: { idPerfil: idPerfil },
                success: function (data) {
                    renderizarAcordeon(data);
                },
                error: function () {
                    $("#tree-container").html('<div class="alert alert-danger">Error al cargar las opciones.</div>');
                }
            });
        }

        // --- FUNCIÓN 2: DIBUJAR HTML (ACORDEONES) ---
        function renderizarAcordeon(listaSistemas) {
            var html = '<div class="accordion" id="accordionPermisos">';

            $.each(listaSistemas, function (index, sistema) {
                var idCollapse = "collapse" + index;
                var idHeading = "heading" + index;

                // Cabecera del Acordeón (Sistema)
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${idHeading}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${idCollapse}" aria-expanded="false" aria-controls="${idCollapse}">
                                <i class="fas fa-folder me-2"></i> ${sistema.nombre}
                            </button>
                        </h2>
                        <div id="${idCollapse}" class="accordion-collapse collapse" aria-labelledby="${idHeading}" data-bs-parent="#accordionPermisos">
                            <div class="accordion-body bg-light">
                                <div class="list-group">
                `;

                // Cuerpo del Acordeón (Opciones Checkboxes)
                $.each(sistema.opciones, function (i, opcion) {
                    var isChecked = opcion.asignado ? "checked" : "";

                    html += `
                        <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-circle text-secondary me-2" style="font-size:8px;"></i>${opcion.nombre}</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input chk-opcion" type="checkbox" value="${opcion.codigo}" ${isChecked}>
                            </div>
                        </label>
                    `;
                });

                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            $("#tree-container").html(html);
        }

        // --- FUNCIÓN 3: GUARDAR (POST) ---
        function guardarPermisos() {
            var idPerfil = $("#cboPerfil").val();
            var idsSeleccionados = [];

            // Recorrer todos los checkboxes marcados
            $(".chk-opcion:checked").each(function () {
                idsSeleccionados.push($(this).val());
            });

            // SweetAlert de Confirmación
            Swal.fire({
                title: '¿Guardar Cambios?',
                text: "Se actualizarán los permisos para este perfil.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#004aad',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarDatosServidor(idPerfil, idsSeleccionados);
                }
            });
        }

        function enviarDatosServidor(idPerfil, listaIds) {
            $.ajax({
                url: urlGuardarPermisos,
                type: "POST",
                data: {
                    idPerfil: idPerfil,
                    idsSeleccionados: listaIds
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire('¡Guardado!', response.message, 'success');
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'Error de comunicación con el servidor', 'error');
                }
            });
        }

    </script>
}